[[100 ошибок в Go и как их избежать]]

Карта в Go - указатель на структуру `runtime.hmap`
```go
type hmap struct {
	B uint8
}
```
`B` - кол-во сегментов
Проблема карт в том, что они могут только увеличиваться. 
```go
func main() {
    m := make(map[int][]byte)
    n := 1_000_000
    PrintAlloc()
    for i := 0; i < n; i++ {
        m[i] = randBytes()
    }
    PrintAlloc()
    for i := 0; i < n; i++ {
        delete(m, i)
    }
    runtime.GC()
    PrintAlloc()
    runtime.KeepAlive(m)
}
```
Создадим карту на 1000000 эллементов, заполним карту, посмотрим сколько памяти выделилось, а потом удалим все элементы и запустим сборщик
```
0 MB
235 MB
72 MB
```
После удаления всех элементов в памяти все еще живут сегменты, но пустые. 
Одним из решений проблемы может быть копирование текущего состояния карты. Другим решением будет хранение указателя на слайс. Это будет значить, что сегмент будет резервировать память только под размер указателя.

```go
func main() {
    m := make(map[int]*[]byte)
    n := 1_000_000
    PrintAlloc()
    for i := 0; i < n; i++ {
        m[i] = randBytes()
    }
    PrintAlloc()
    for i := 0; i < n; i++ {
        delete(m, i)
    }
    runtime.GC()
    PrintAlloc()
    runtime.KeepAlive(m)
}
```

```
0 MB
205 MB
38 MB
```
