[[Postgres]]
Один инстанс постгреса обслуживает множество баз данных\
Логическое устройство:
![[Pasted image 20241123170130.png]]
Физическое устройство, как оно там на диске
![[Pasted image 20241123170245.png]]
Любой объект БД - это head блок
![[Pasted image 20241123170603.png]]

## Обработка запросов
Жизненный цикл запроса
![[Pasted image 20241123171006.png]]
### Parser
На стадии **Parser** проверяется верен ли запрос синтаксически. Строится дерево и передается дальше ![[Pasted image 20241123171338.png]]
### Analyzer
Прилетает дерево с предыдущего этапа. На стадии **Analyzer** проверяется существуют ли такие таблицы, колонки, которые фигурируют в запрос. Тут уже он идет в данные и проверяет все. На этом этапе также начинается конкуренция за доступ к данным ![[Pasted image 20241123171513.png]]
### Rewriter
На стадии **Rewriter** происходит переписывание представлений, если они есть в запросе. То есть в запрос подставится вьюха, которую мы указали.![[Pasted image 20241123171802.png]]
### Planner
На стадии **Planner** строится план запроса. Куда запрос пойдет, какими методами будет делается выборка и тд. План можно посмотреть через `explain`. План исполняется снизу вверх! От дочерних узлов в родителями.  `cost` - это стоимость выполнения запроса. 
- Первое число означает стоимость для начала выполнения запроса
- Второе число после `..` означает суммарную стоимость операции
![[Pasted image 20241123171848.png]]
### Executor
Занимается выполнением запроса по плану из Planner
![[Pasted image 20241123172622.png]]
## Методы доступа и соединения таблиц
### Методы доступа
Методы доступа - это то, как постгрес будет читать данные с диска
- Seq scan - постгрес пойдет на диск и будет последовательно читать данные. Подходит для больших выборок
- index scan - постгрес будет искать данные по индексу. Хорошо на маленьких выборках
- index only scan 
- bitmap scan - сканирование по битовой карте. Хорошо на средних выборках
### Методы соединения таблиц
Есть три типа соединения таблиц
#### Nested loop
Nested loop - для небольших выборок. Работает как вложенный цикл, кто бы мог подумать. Берем значение из первой выборки и пробегаемся по каждому значению из второй выборки и тд. 
![[Pasted image 20241123173724.png]]
Не требует никакой подготовки
![[Pasted image 20241123174110.png]]
Обе колонки ПК - значит есть индекс. Поэтому и там и там индексное сканирование
#### Hash Join
Требует подготовки - вычисление хэша
![[Pasted image 20241123173813.png]]
Подходит только для операции равно
![[Pasted image 20241123174147.png]]

#### Merge join
Эффективен на больших выборках. Работает только на отсортированных данных
![[Pasted image 20241123173930.png]]
Возвращает отсортированные данные и поддерживает только операции равенства
![[Pasted image 20241123174218.png]]
## Процессы СУБД 
![[Pasted image 20241123174821.png]]
